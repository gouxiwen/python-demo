{% extends 'base.html' %}
{% block header %}
<div class="search flex-center">
  <input class="search-input" type="text" placeholder="搜索文章..." value="{{ query }}"
    onkeypress="if(event.key==='Enter'){location.href=`/?query=${document.querySelector('.search-input').value}`}">
</div>
<!-- 标签展示区 -->
<div class="tags-list">
  <span class="tag-title" onclick="location.href=`/`">标签：</span>
  {% for tag in tags %}
  {% if current_tag != null and tag['id'] == current_tag['id'] %}
  <a href="{{ url_for('blog.tag_posts', tag_id=tag['id']) }}" class="tag-item selected">{{ tag['name'] }}</a>
  {% else %}
  <a href="{{ url_for('blog.tag_posts', tag_id=tag['id']) }}" class="tag-item">{{ tag['name'] }}</a>
  {% endif %}
  {% endfor %}
</div>
<div class="flex-center flex-between">
  <h1 class="h1">{% block title %}文章列表{% endblock %}</h1>
  {% if g.user %}
  <a class="action" href="{{ url_for('blog.create') }}">写文章</a>
  {% endif %}
</div>
{% endblock %}

{% block content %}
{% for post in posts %}
<article class="post">
  <header>
    <div>
      <h1 class="title" onclick="location.href=`{{ url_for('blog.view', id=post['id']) }}`">{{ post['title'] }}</h1>
      <div class="about">{{ post['username'] }} 发布于 {{ post['created'].strftime('%Y-%m-%d %H:%M:%S') }}</div>
    </div>
    {% if g.user['id'] == post['author_id'] %}
    <a class="action" href="{{ url_for('blog.update', id=post['id']) }}">编辑</a>
    {% endif %}
  </header>
  <div class="post-content ellipsis" data-content="{{ post['body']|e }}"></div>
</article>
{% if not loop.last %}
<br>
{% endif %}
{% endfor %}

<!-- 分页导航 -->
{% if total_pages > 1 %}
<div class="pagination">
  <div class="pagination-container">
    {% if page > 1 %}
    <a href="{{ url_for('blog.index', page=page-1, query=query) }}" class="pagination-link">上一页</a>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
      {% if p == page %}
        <span class="pagination-current">{{ p }}</span>
      {% else %}
        <a href="{{ url_for('blog.index', page=p, query=query) }}" class="pagination-link">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if page < total_pages %}
    <a href="{{ url_for('blog.index', page=page+1, query=query) }}" class="pagination-link">下一页</a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- 标签页分页导航 -->
{% if current_tag %}
<div class="pagination">
  <div class="pagination-container">
    {% if page > 1 %}
    <a href="{{ url_for('blog.tag_posts', tag_id=current_tag['id'], page=page-1) }}" class="pagination-link">上一页</a>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
      {% if p == page %}
        <span class="pagination-current">{{ p }}</span>
      {% else %}
        <a href="{{ url_for('blog.tag_posts', tag_id=current_tag['id'], page=p) }}" class="pagination-link">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if page < total_pages %}
    <a href="{{ url_for('blog.tag_posts', tag_id=current_tag['id'], page=page+1) }}" class="pagination-link">下一页</a>
    {% endif %}
  </div>
</div>
{% endif %}
<style>
  .search {
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .search .search-input {
    flex-grow: 1;
  }

  .pagination {
    margin: 2rem 0;
    display: flex;
    justify-content: center;
  }

  .pagination-container {
    display: flex;
    gap: 0.5rem;
  }

  .pagination-link {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
  }

  .pagination-link:hover {
    background-color: #f5f5f5;
  }

  .pagination-current {
    padding: 0.5rem 1rem;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
  }

</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // 使用marked.js解析Markdown内容并只显示第一行
  document.addEventListener('DOMContentLoaded', function() {
    const postContents = document.querySelectorAll('.post-content');
    postContents.forEach(function(content) {
      const markdownText = content.getAttribute('data-content');
      if (markdownText) {
        // 只取第一行内容
        const firstLine = markdownText.split('\n')[0];
        
        // 配置marked选项
        marked.setOptions({
          breaks: true,
          gfm: true
        });
        // 渲染Markdown为HTML
        const htmlContent = marked.parse(firstLine);
        content.innerHTML = htmlContent;
      }
    });
  });
</script>
{% endblock %}